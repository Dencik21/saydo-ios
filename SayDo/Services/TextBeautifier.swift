import Foundation

final class TextBeautifier {

    func beautify(_ text: String) -> String {
        var t = text.trimmingCharacters(in: .whitespacesAndNewlines)
        t = t.lowercased()

        // 1) –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã
        t = t.replacingOccurrences(of: #"\s+"#, with: " ", options: .regularExpression)

        // 2) —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ "–ø–æ—Ç–æ–º/–∑–∞—Ç–µ–º/–µ—â—ë" ‚Üí —Ç–æ—á–∫–∏
        let separators = [
            " –∏ –ø–æ—Ç–æ–º ", " –ø–æ—Ç–æ–º ", " –∑–∞—Ç–µ–º ", " –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ ", " –¥–∞–ª–µ–µ ", " –ø–æ—Ç–æ–º –∂–µ ",
            " –¥–∞–ª—å—à–µ ", " –∏ –¥–∞–ª—å—à–µ ", " –µ—â–µ ", " –µ—â—ë ", " –∏ –µ—â–µ ", " –∏ –µ—â—ë ",
            " —á—Ç–æ –µ—â–µ ", " —á—Ç–æ –µ—â—ë "
        ]
        for s in separators {
            t = t.replacingOccurrences(of: s, with: ". ")
        }

        // 3) üî• –≥–ª–∞–≥–æ–ª—ã-–¥–µ–π—Å—Ç–≤–∏—è ‚Üí —Å—Ç–∞–≤–∏–º —Ç–æ—á–∫—É –ü–ï–†–ï–î –Ω–æ–≤—ã–º –¥–µ–π—Å—Ç–≤–∏–µ–º (–µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –≤ –Ω–∞—á–∞–ª–µ)
        //    –≠—Ç–æ —Ä–µ—à–∞–µ—Ç —Ç–≤–æ–π –∫–µ–π—Å "–∫—É–ø–∏—Ç—å ... –ø–æ–π—Ç–∏ ... –∑–∞–ø–∏—Å–∞—Ç—å—Å—è ..."
        let verbs = [
            "–∫—É–ø–∏—Ç—å", "–ø–æ–π—Ç–∏", "—Å—Ö–æ–¥–∏—Ç—å", "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–ø–æ–∑–≤–æ–Ω–∏—Ç—å", "–Ω–∞–ø–∏—Å–∞—Ç—å",
            "—Å–¥–µ–ª–∞—Ç—å", "–æ–ø–ª–∞—Ç–∏—Ç—å", "–∑–∞–∫–∞–∑–∞—Ç—å", "–≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è", "—É–±—Ä–∞—Ç—å", "–ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å"
        ]

        for v in verbs {
            // –∑–∞–º–µ–Ω—è–µ–º " ... <verb> " –Ω–∞ ". <verb> " (–Ω–æ –Ω–µ –µ—Å–ª–∏ verb –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ)
            t = t.replacingOccurrences(
                of: #"(?<!^)\s+\#(v)\b"#,
                with: ". \(v)",
                options: .regularExpression
            )
        }

        // 4) –º—è–≥–∫–æ –¥–µ–ª–∏–º –ø–æ " –∏ " (–±–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞) ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ/–ø–æ—Å–ª–µ –µ—Å—Ç—å 3+ –±—É–∫–≤—ã
        //    –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç "–∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ –∏ —Ö–ª–µ–±"
        t = t.replacingOccurrences(
            of: #"\b(.{3,})\s+–∏\s+(.{3,})\b"#,
            with: "$1. $2",
            options: .regularExpression
        )

        // 5) —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —á–∏—Å—Ç–∫–∞
        t = t.replacingOccurrences(of: #"\s+"#, with: " ", options: .regularExpression)
        t = t.trimmingCharacters(in: .whitespacesAndNewlines)

        // 6) —Ç–æ—á–∫–∞ –≤ –∫–æ–Ω—Ü–µ
        if let last = t.last, ".!?".contains(last) == false {
            t += "."
        }

        return t
    }
}
